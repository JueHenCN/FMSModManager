@using FMSModManager.Core.Services
@using Prism.Events
@using FMSModManager.Core.Events
@using FMSModManager.Pages.Components
@inject LanguageService Lang

<MudNavMenu>
    <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">@Lang.GetText("Home")</MudNavLink>
    
    <MudNavGroup Title="@Lang.GetText("LocalMods")" Icon="@Icons.Material.Filled.Storage">
        <MudNavGroup Title="@Lang.GetText("ReligionMods")" Icon="@Icons.Material.Filled.TempleBuddhist">
            @foreach (var mod in _religionMods)
            {
                <MudNavLink Href="@($"local-mods/religion/{mod}")" Icon="@Icons.Material.Filled.Article">
                    @mod
                </MudNavLink>
            }
        </MudNavGroup>
        <MudNavLink Href="local-mods/culture" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Diversity3">
            @Lang.GetText("CultureMods")
        </MudNavLink>
    </MudNavGroup>
    
    <MudNavGroup Title="@Lang.GetText("WorkshopMods")" Icon="@Icons.Material.Filled.ShoppingCart">
        <MudNavLink Href="workshop-mods/religion" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.TempleBuddhist">
            @Lang.GetText("ReligionMods")
        </MudNavLink>
        <MudNavLink Href="workshop-mods/culture" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Diversity3">
            @Lang.GetText("CultureMods")
        </MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="@Lang.GetText("Language")" Icon="@Icons.Material.Filled.Language">
        @foreach (var language in LanguageService.AvailableLanguages.OrderBy(x => x.Value.Name))
        {
            <MudNavLink OnClick="@(() => ChangeLanguage(language.Key))"
                       Icon="@(language.Key == LanguageService.CurrentLanguage ? 
                              Icons.Material.Filled.RadioButtonChecked : 
                              Icons.Material.Filled.RadioButtonUnchecked)">
                @language.Value.Name
            </MudNavLink>
        }
    </MudNavGroup>
</MudNavMenu>

@code {
    private List<string> _religionMods = new();
    
    [Inject]
    private ReligionService ReligionService { get; set; }
    [Inject]
    private IEventAggregator EventAggregator { get; set; }
    [Inject]
    private LanguageService LanguageService { get; set; }
    
    private void RefreshMods()
    {
        _religionMods = ReligionService.GetAvailableReligionMods();
        StateHasChanged();
    }
    
    protected override void OnInitialized()
    {
        RefreshMods();
        EventAggregator.GetEvent<ModsChangedEvent>().Subscribe(RefreshMods);
    }
    
    public void Dispose()
    {
        EventAggregator.GetEvent<ModsChangedEvent>().Unsubscribe(RefreshMods);
    }

    private void ChangeLanguage(string language)
    {
        LanguageService.SetLanguage(language);
    }
}
