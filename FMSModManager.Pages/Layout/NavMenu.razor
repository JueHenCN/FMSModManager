@using FMSModManager.Core.Services
@using Prism.Events
@using FMSModManager.Core.Events
@using FMSModManager.Pages.Components
@inject LanguageService Lang

<MudNavMenu>
    <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">@Lang.GetText("Home")</MudNavLink>
    
    <MudNavGroup Title="@Lang.GetText("LocalMods")" Icon="@Icons.Material.Filled.Storage">
        <MudNavGroup Title="@Lang.GetText("ReligionMods")" Icon="@Icons.Material.Filled.TempleBuddhist">
            @foreach (var mod in _religionMods)
            {
                <MudNavLink Href="@($"local-mods/religion/{mod}")" Icon="@Icons.Material.Filled.Article">
                    @mod
                </MudNavLink>
            }
        </MudNavGroup>

        <MudNavGroup Title="@Lang.GetText("CultureMods")" Icon="@Icons.Material.Filled.Diversity3">
            @foreach (var mod in _cultureMods)
            {
                <MudNavLink Href="@($"local-mods/culture/{mod}")" Icon="@Icons.Material.Filled.Article">
                    @mod
                </MudNavLink>
            }
        </MudNavGroup>
    </MudNavGroup>
    
    <MudNavGroup Title="@Lang.GetText("WorkshopMods")" Icon="@Icons.Material.Filled.ShoppingCart">

        <MudNavGroup Title="@Lang.GetText("SubscriptionMods")" Icon="@Icons.Material.Filled.Download">
            @foreach (var mod in _subscriptionMods)
            {
                <MudNavLink Href="@($"workshop-mods/subscription/{mod}")" Icon="@Icons.Material.Filled.Article">
                    @mod
                </MudNavLink>
            }
        </MudNavGroup>

        <MudNavGroup Title="@Lang.GetText("PublishMods")" Icon="@Icons.Material.Filled.Upload">
            @foreach (var mod in _publishMods)
            {
            <MudNavLink Href="@($"workshop-mods/publish/{mod}")" Icon="@Icons.Material.Filled.Article">
                @mod
                </MudNavLink>
            }
        </MudNavGroup>
    </MudNavGroup>

    <MudNavGroup Title="@Lang.GetText("Language")" Icon="@Icons.Material.Filled.Language">
        @foreach (var language in LanguageService.AvailableLanguages.OrderBy(x => x.Value.Name))
        {
            <MudNavLink OnClick="@(() => ChangeLanguage(language.Key))"
                       Icon="@(language.Key == LanguageService.CurrentLanguage ? 
                              Icons.Material.Filled.RadioButtonChecked : 
                              Icons.Material.Filled.RadioButtonUnchecked)">
                @language.Value.Name
            </MudNavLink>
        }
    </MudNavGroup>
</MudNavMenu>

@code {
    private List<string> _religionMods = new();
    private List<string> _cultureMods = new();
    private List<string> _subscriptionMods = new();
    private List<string> _publishMods = new();
    
    [Inject]
    private ReligionService ReligionService { get; set; }
    [Inject]
    private CultureService CultureService { get; set; }
    [Inject]
    private SteamworkService SteamworkService { get; set; }
    [Inject]
    private IEventAggregator EventAggregator { get; set; }
    [Inject]
    private LanguageService LanguageService { get; set; }
    
    private void RefreshMods()
    {
        _religionMods = ReligionService.GetAvailableReligionMods();
        _cultureMods = CultureService.GetAvailableCultures();
        _subscriptionMods = SteamworkService.GetAvailableSubscriptionMods();
        _publishMods = SteamworkService.GetAvailablePublishMods();
        StateHasChanged();
    }
    
    protected async override void OnInitialized()
    {
        await SteamworkService.RefauseWorkShopModList();
        EventAggregator.GetEvent<ModsChangedEvent>().Subscribe(RefreshMods);
        EventAggregator.GetEvent<SteamworkServiceRefuseEvent>().Subscribe(RefreshMods);
        RefreshMods();
    }
    
    public void Dispose()
    {
        EventAggregator.GetEvent<ModsChangedEvent>().Unsubscribe(RefreshMods);
        EventAggregator.GetEvent<SteamworkServiceRefuseEvent>().Unsubscribe(RefreshMods);
    }

    private void ChangeLanguage(string language)
    {
        LanguageService.SetLanguage(language);
    }
}
